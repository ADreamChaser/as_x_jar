<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Zxing 改装官方demo</title>
	<base target="_blank">
</head>
<body>
	<h3>1，参考</h3>
	<a href="https://github.com/zxing/zxing">Google官方demo</a><br>
	<a href="https://jcenter.bintray.com/com/google/zxing/core/">Zxing的aar地址</a><br>
	<a href="https://www.jianshu.com/p/9bd4e5d8a405">Zxing扫描集成与优化</a><br>
	<a href="https://www.jianshu.com/p/206205ff00df">Zxing扫描，横屏改竖屏</a><br>
	<a href="https://github.com/yline/as_x_jar/tree/master/zxing">ZxingDemo地址</a><br>

	<h3>2，集成与简化</h3>
	<div>1) 下载并运行：从github上clone代码到本地，运行。如果崩溃，检查相机权限</div>
	<dl>2) 简化代码
		<li>删除工程中SP保存数据的代码，直接使用常量替代</li>
		<li>删除【result目录和share目录中】二次处理扫描结果的部分</li>
		<li>删除部分无用的Activity、冗余的资源文件</li>
		<li>新建入口Activity，再跳转至扫描界面，提供缓冲；并方便增加解码和识别图片的直接入口</li>
		<li>CameraManager弄成单例，首次调用时初始化；方便后期解耦</li>
	</dl>

	<div>3) 最终简化结果样例</div>
	<a href="https://github.com/yline/as_x_jar/tree/master/zxing">ZxingDemo地址</a><br>
	<img src="zxing_catalog_simply.png">

	<h3>3，源码介绍</h3>
	<dl>1) Lib模块
		<li>camera: 调用摄像头预览，并得到byte[]</li>
		<li>decode: 将byte[]解析出来，并回调到UI层</li>
		<li>view: 预览界面</li>
		<li>helper: 实现附加功能[生成二维码、解析图片二维码、日志统一管理、闪光灯和声音管理]</li>
	</dl>

	<div>2) 二维码和条形码</div>
	<div>二维码使用：BarcodeFormat.QR_CODE、BarcodeFormat.DATA_MATRIX</div>
	<div>一维码使用：BarcodeFormat.CODE_128【支付宝付款码、微信付款码使用此类型】</div>
	<table border="1" cellspacing="0" cellpadding="10">
		<tr>
			<td rowspan="1"></td>
			<td>编号</td>
			<td>简介</td>
		</tr>
		<tr>
			<td rowspan="5">二维码</td>
			<td>BarcodeFormat.QR_CODE</td>
			<td>普通二维码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.DATA_MATRIX</td>
			<td>矩阵式二维码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.AZTEC</td>
			<td>高容量二维码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.PDF_417</td>
			<td>堆叠式二维码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.MAXICODE</td>
			<td>多功能条码</td>
		</tr>
		<tr>
			<td rowspan="10">一维码</td>
			<td>BarcodeFormat.UPC_A</td>
			<td>定长码，只能表示13位数字</td>
		</tr>
		<tr>
			<td>BarcodeFormat.UPC_E</td>
			<td>短码，总长度位8个字码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.EAN_13</td>
			<td>欧洲商品条形码，总长度为13位</td>
		</tr>
		<tr>
			<td>BarcodeFormat.EAN_8</td>
			<td>欧洲商品码，总长度为8位</td>
		</tr>
		<tr>
			<td>BarcodeFormat.CODABAR</td>
			<td>过时，不推荐使用</td>
		</tr>
		<tr>
			<td>BarcodeFormat.CODE_39</td>
			<td>长度不限制，简单方便实用，能够对0-9，A-Z，+-*/%$进行编码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.CODE_93</td>
			<td>128px，维基百科找不到相应链接</td>
		</tr>
		<tr>
			<td>BarcodeFormat.CODE_128</td>
			<td>维基百科找不到相应链接</td>
		</tr>
		<tr>
			<td>BarcodeFormat.ITF</td>
			<td>非零售包装的水平，交错2/5码</td>
		</tr>
		<tr>
			<td>BarcodeFormat.RSS_14</td>
			<td>GS1的的 DataBar 的前身缩减码</td>
		</tr>
	</table><br>

	<div>3) Camera和Display的横竖方向</div>
	<div>CameraConfigurationManager.initFromCameraParameters()，中打印了相关信息</div>
	<br>

	<div>4) Camera和Display的窗口大小</div>
	<div>UI展示Rect: CameraManager.getFramingRect()</div>
	<div>预览解析Rect: CameraManager.getFramingRectInPreview()</div>

	<h3>4，解决的问题</h3>
	<div>1) 扫码界面横屏转竖屏，链接：
		<a href="https://www.jianshu.com/p/206205ff00df">Zxing扫描，横屏改竖屏</a></div>
	<br>

	<div>2) 识别大图片时，识别失败，存在OOM问题</div>
	<xmp>
	public static Bitmap loadBitmap(String sourcePath, int scale) {
		BitmapFactory.Options options = new BitmapFactory.Options();
		options.inJustDecodeBounds = false;
		options.inSampleSize = scale; // 直接减小采样率
		
		options.inPreferredConfig = Bitmap.Config.ALPHA_8; // 降低单个像素的内存大小
		return BitmapFactory.decodeFile(sourcePath, options);
	}
	</xmp>

	<div>3) 扫描界面，首次进入黑屏</div>
	<xmp>
	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		
		...
		mCaptureFragment = new CaptureFragment(); // 具体实现扫码界面的控件
		mCaptureFragment.setOnResultCallback(this);
		
		// 若无权限，则请求权限
		boolean isRequestPermission = PermissionUtil.request(this, PermissionUtil.REQUEST_CODE_PERMISSION, Manifest.permission.CAMERA);
		if (!isRequestPermission) {
			getFragmentManager().beginTransaction().add(R.id.capture_frame, mCaptureFragment).commit();
		}
	}
	
	@Override
	public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
		super.onRequestPermissionsResult(requestCode, permissions, grantResults);
		
		boolean isPermissionGranted = PermissionUtil.isPermissionGranted(grantResults);
		if (isPermissionGranted) {
			getFragmentManager().beginTransaction().add(R.id.capture_frame, mCaptureFragment).commit();
		} else {
			SDKManager.toast("未授予权限，扫描功能不能使用");
			finish();
		}
	}
	</xmp>


	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
	<br>
</body>
</html>